name: Run PR docker-compose based tests
on: pull_request

jobs:
  pr_tests:
    name: Run PR tests
    runs-on: ubuntu-latest
    env:
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      TAG: pr
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: install packages
        run: |
          set -e
          sudo apt-get update
          sudo apt-get -y install python3-pip

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: pull latest pr tag
        run: |
          set -e
          docker pull ghcr.io/azulinho/cryptobot:pr || true
          docker pull ghcr.io/azulinho/klines_caching_service:pr || true

      - name: run build
        run: |
          set -e
          TAG=pr ./run build

      - name: run klines-caching-service in background
        run: |
          set -e
          TAG=pr ./run klines-caching-service RUN_IN_BACKGROUND=yes

      - name: Push PR docker images
        run: |
          set -e
          docker push ghcr.io/azulinho/cryptobot:pr
          docker push ghcr.io/azulinho/klines_caching_service:pr

      - name: copy secrets
        run: cp tests/fake.yaml secrets/binance.prod.yaml

      - name: run backtesting strategies BuyMoonSellRecoveryStrategy.yaml
        run: |
          set -ex
          echo BuyMoonSellRecoveryStrategy.yaml
          cp tests/BuyMoonSellRecoveryStrategy.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyMoonSellRecoveryStrategy.yaml
          grep 'wins:366 losses:98 stales:104 holds:1' results/BuyMoonSellRecoveryStrategy.yaml.txt

      - name: run backtesting strategies BuyOnGrowthTrendAfterDropStrategy.yaml
        run: |
          set -ex
          echo BuyOnGrowthTrendAfterDropStrategy.yaml
          cp tests/BuyOnGrowthTrendAfterDropStrategy.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyOnGrowthTrendAfterDropStrategy.yaml
          grep 'wins:19 losses:1 stales:75 holds:2' results/BuyOnGrowthTrendAfterDropStrategy.yaml.txt

      - name: run backtesting strategies BuyDropSellRecoveryStrategy.yaml
        run: |
          set -ex
          echo BuyDropSellRecoveryStrategy.yaml
          cp tests/BuyDropSellRecoveryStrategy.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyDropSellRecoveryStrategy.yaml
          grep 'wins:4 losses:9 stales:1 holds:0' results/BuyDropSellRecoveryStrategy.yaml.txt

      - name: run backtesting strategies BuyDropSellRecoveryStrategyWhenBTCisUp.yaml
        run: |
          set -ex
          echo BuyDropSellRecoveryStrategyWhenBTCisUp.yaml
          cp tests/BuyDropSellRecoveryStrategyWhenBTCisUp.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyDropSellRecoveryStrategyWhenBTCisUp.yaml
          grep 'wins:199 losses:2 stales:637 holds:0' results/BuyDropSellRecoveryStrategyWhenBTCisUp.yaml.txt

      - name: run backtesting strategies BuyDropSellRecoveryStrategyWhenBTCisDown.yaml
        run: |
          set -ex
          echo BuyDropSellRecoveryStrategyWhenBTCisDown.yaml
          cp tests/BuyDropSellRecoveryStrategyWhenBTCisDown.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyDropSellRecoveryStrategyWhenBTCisDown.yaml
          grep 'wins:9 losses:0 stales:97 holds:0' results/BuyDropSellRecoveryStrategyWhenBTCisDown.yaml.txt

      - name: run backtesting strategies BuyOnRecoveryAfterDropDuringGrowthTrendStrategy.yaml
        run: |
          set -ex
          echo BuyOnRecoveryAfterDropDuringGrowthTrendStrategy.yaml
          cp tests/BuyOnRecoveryAfterDropDuringGrowthTrendStrategy.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyOnRecoveryAfterDropDuringGrowthTrendStrategy.yaml
          grep 'wins:112 losses:0 stales:351 holds:0' results/BuyOnRecoveryAfterDropDuringGrowthTrendStrategy.yaml.txt

      - name: run backtesting strategies BuyOnRecoveryAfterDropFromAverageStrategy.yaml
        run: |
          set -ex
          echo BuyOnRecoveryAfterDropFromAverageStrategy.yaml
          cp tests/BuyOnRecoveryAfterDropFromAverageStrategy.yaml configs/
          TAG=pr ./run backtesting CONFIG_FILE=BuyOnRecoveryAfterDropFromAverageStrategy.yaml
          grep 'wins:184 losses:4 stales:596 holds:0' results/BuyOnRecoveryAfterDropFromAverageStrategy.yaml.txt

      - name: run automated-backtesting
        run: |
          set -ex
          echo automated-tests
          LOGFILE=tests/price.log.gz
          CONFIG_FILE=tests/automated-backtesting.yaml
          MIN=1
          FILTER=""
          cp $CONFIG_FILE configs/
          cp $LOGFILE log/lastfewdays.log.gz
          TAG=pr ./run automated-backtesting LOGFILE=lastfewdays.log.gz CONFIG_FILE=automated-backtesting.yaml MIN=1 FILTER='' SORTBY=profit PORT1=8991 PORT2=8992 PORT3=8993 PORT4=8994
